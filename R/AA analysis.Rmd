---
title: "ICPMS analysis"
output: html_document
---

```{r include=FALSE}
library(tidyverse)
library(readr)
library(janitor)

```

#load data
```{r}
icpms<-read.csv("~/Chem 313 lab/ICMPS lab/Soil_data/ICPMS_tidy.csv")
icpms
```

```{r}
sample_sites <- unique(filter(icpms, Site!="MB",  Site!= "")$site)
#exlcuding method blancks and others
metals_analyzed <- unique(icpms$metal)

#preview
sample_sites
metals_analyzed

```

```{r}
#start loop and filter the Cal data
icpms_cal<- NULL
for (unique_metal in metals_analyzed) {
  cal<- icpms%>%
    filter(Type== "Cal1" |Type == "Cal2" | Type== "Cal3")%>%
    filter(metal== unique_metal)%>%
    select(Concentration, CPS, RSD)

#use linear regression to pull relevant data into model

w<- 1/(cal$CPS*cal$RSD)^2
model<- lm(cal$CPS ~ cal$Concentration, weights=w)

slope<- model$coefficients[2]
intercept<- model$coefficients[1]
slope_std <-summary(model)$coefficients[2,2]
intercept_std<- summary(model)$coefficients[1,2]

#plot the curve
plot(cal$CPS~ cal$Concentration,
     xlab= paste("Concentration of ", unique_metal, "(ppb)"),#units from the standard(ug/L)

ylab= "Counts per second")+
  abline(model,col="blue")+
  title(paste("Calibration for", unique_metal))
     
#store for loop
equation<-  tibble(metal = unique_metal,  slope, slope_std, intercept, intercept_std)
icpms_cal<- rbind(icpms_cal, equation)
}
icpms_cal

remove(equation, cal,slope, slope_std, intercept, intercept_std, w, model, unique_metal)
```

#create function 
```{r}
#inputs: unique_site (as a character, ex. "A")
#Outputs: concentration vector
sample_analysis<- function(unique_site){
  concentration_data<- NULL
  for (unique_metal in metals_analyzed){
    sample<- filter(icpms, metal== unique_metal, site == unique_site)
    data<-NULL
    for (ID in sample$sample_key) {
      sample_data<- filter(sample, sample_key == ID)
      cal<- filter(icpms_cal, metal ==   unique_metal)
      
      #dample anaylysis
      m<- cal$slope
      b<-cal$intercept
      y<- sample_data$CPS
      
      b_e<-cal$intercept_std
      m_e<-slope_std
      
      x<- (y-b?m)
      
      RSD<- sample_data$RSD
      CPS<-sample_data$CPS
      
      #error propigation
      e_yb <- sqrt((RSD)^2 + (b_e)^2)
      #error in y-b from the calibration
      yb<- x*sqrt((e_yb/yb)^2 +(m_e/m)^2)
      #error in x from the calibration
      data<- rbind(data, data_frame(sample_key = ID, x, e_x))
      if (unique_site != "MB"){
        concentraction_data<-data_frame(sample_key=sample_data$sample_key,
                                        analyst= sample_data$analyst,
                                        metal= unique_metal,
                                        site = unique_site,
                                        conc_dil = x,
                                        conc_dil_error= e_x)%>%
          rbind(concentraction_data)
      }
      if (unique_site== "MB"){
        x<- mean(data$x)
        e_x<-sd(data$x)
        concentration_data <- data_frame(metal= unique_metal,
                                         site+ unique_site,
                                         conc_dil =x,
                                         conc_dil_error= e_x)%>%
          rbind(concentration_data)
      }
    }
 return(concentration_data) 
    }
}
```

```{r}

```

