---
title: "ICPMS analysis"
output: html_document
---

```{r include=FALSE}
library(tidyverse)
library(readr)
library(janitor)

```

#load data
```{r}
icpms<-read.csv("~/Chem 313 lab/ICMPS lab/Soil_data/ICPMS_tidy.csv")
icpms
```

```{r}
sample_sites <- unique(filter(icpms, Site!="MB",  Site!= "")$site)
#exlcuding method blancks and others
metals_analyzed <- unique(icpms$metal)

#preview
sample_sites
metals_analyzed

```

```{r}
#start loop and filter the Cal data
icpms_cal<- NULL
for (unique_metal in metals_analyzed) {
  cal<- icpms%>%
    filter(Type== "Cal1" |Type == "Cal2" | Type== "Cal3")%>%
    filter(metal== unique_metal)%>%
    select(Concentration, CPS, RSD)

#use linear regression to pull relevant data into model

w<- 1/(cal$CPS*cal$RSD)^2
model<- lm(cal$CPS ~ cal$Concentration, weights=w)

slope<- model$coefficients[2]
intercept<- model$coefficients[1]
slope_std <-summary(model)$coefficients[2,2]
intercept_std<- summary(model)$coefficients[1,2]

#plot the curve
plot(cal$CPS~ cal$Concentration,
     xlab= paste("Concentration of ", unique_metal, "(ppb)"),#units from the standard(ug/L)

ylab= "Counts per second")+
  abline(model,col="blue")+
  title(paste("Calibration for", unique_metal))
     
#store for loop
equation<-  tibble(metal = unique_metal,  slope, slope_std, intercept, intercept_std)
icpms_cal<- rbind(icpms_cal, equation)
}
icpms_cal

remove(equation, cal,slope, slope_std, intercept, intercept_std, w, model, unique_metal)
```

